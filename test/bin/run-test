#!/usr/bin/env bash
# TODO: This depends on bash's PIPESTATUS

# Runs the test $CTEST_DRIVER
if [ -z $CTEST_BINDIR ]; then die "Missing environment variable \$CTEST_BINDIR"; fi
if [ -z $CTEST_TMPDIR ]; then die "Missing environment variable \$CTEST_TMPDIR"; fi
if [ -z $CTEST_DRIVER ]; then die "Missing environment variable \$CTEST_DRIVER"; fi
if [ -z $CTEST_REPORT_FILE ]; then die "Missing environment variable \$CTEST_REPORT_FILE"; fi

# Temporary file to collect stderr output
TMPFILE=`mktemp $CTEST_TMPDIR/cc-wrapper.XXXXXX` || exit 1

# Run the test, teeing output to TMPFILE
$CTEST_BINDIR/$CTEST_DRIVER +RTS -M64M -RTS $@ 2>&1 | tee $TMPFILE

# If return status of test driver isn't 0, we have a fatal error and report it.
if [ $PIPESTATUS -ne 0 ]; then
	if [ -n $CTEST_DEBUG ]; then
		echo '[DEBUG]: Fatal Error (Caught)' 2>&1
 	fi
	$CTEST_BINDIR/ReportFatal $CTEST_REPORT_FILE $@ < $TMPFILE
fi

# Remove the temporary file
rm $TMPFILE