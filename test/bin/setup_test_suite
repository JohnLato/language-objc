#!/bin/bash
# Setup environment variables for running a test suite

function die() {
	echo $1 1>&2
	exit 1	
}

if [ ! -d $CTEST_BINDIR ];    then die "Missing environment variable \$CTEST_BINDIR"; fi
if [ ! -d $CTEST_RESULTDIR ]; then die "Missing environment variable \$CTEST_RESULTDIR"; fi
if [ -z $TESTNAME ];          then die "Missing environment variable \$TESTNAME"; fi

# Add the testing bindir to the $PATH variable
export PATH=$CTEST_BINDIR:$PATH

export CTEST_TMPDIR=$CTEST_RESULTDIR/$TESTNAME/
export CTEST_REPORT_FILE=$CTEST_RESULTDIR/$TESTNAME.dat
export CTEST_LOGFILE=$CTEST_TMPDIR/parse.log

# rm is somewhat dangerous, therefore we are careful here

# Create temporary directory for tests
mkdir -p "$CTEST_TMPDIR" || die "Failed to create directory $CTEST_TMPDIR"

# Remove the old report file (with interactive query)
if [ -e "$CTEST_REPORT_FILE" ]; then
	rm -i "$CTEST_REPORT_FILE";
fi

# Ensure the tmp directory is present
if [ ! -d $CTEST_TMPDIR ]; then
	die "No a valid directory : $CTEST_TMPDIR";
	
# If there is a parse.log file in the temporary directory, remove its contents
elif [ -e "$CTEST_TMPDIR"/parse.log ]; then
	rm "$CTEST_TMPDIR"/*
fi